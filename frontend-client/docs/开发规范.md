# 开发规范与经验总结

## 数据库规范

### 1. 数据库迁移规范
- 使用 Alembic 管理所有数据库迁移
- 每次修改模型后必须生成新的迁移文件：`alembic revision --autogenerate -m "描述性信息"`
- 迁移文件命名格式：`YYYYMMDD_HHMM_<revision_id>_<description>.py`
- 执行迁移前先备份数据库
- 遇到迁移冲突时，删除所有迁移文件并重新生成是最简单的解决方案

### 2. 模型定义规范
- 所有模型类必须继承自 `app.db.base_class.Base`
- 模型文件统一放在 `app/models/` 目录下
- 在 `app/models/__init__.py` 中导出所有模型
- 在 `app/db/base.py` 中导入所有模型
- 每个字段必须添加注释说明其用途
- 使用恰当的字段类型，如 JSON 类型存储复杂数据
- 必须设置 `created_at` 和 `updated_at` 字段用于追踪记录变更
- 外键关系必须指定 `ondelete` 规则

### 3. 字段命名规范
- 主键统一使用 `id`
- 外键命名格式：`表名_id`（单数形式）
- 布尔类型字段使用 `is_` 前缀
- 时间戳字段统一使用 `_at` 后缀
- JSON 类型字段使用复数形式表示数组

### 4. 数据库操作规范
- 使用 SQLAlchemy ORM 进行数据库操作
- 复杂查询应该封装在模型的类方法中
- 批量操作使用 `bulk_insert` 或 `bulk_update`
- 查询必须考虑性能优化，合理使用索引
- 大量数据操作时使用分页处理

## 代码组织规范

### 1. 目录结构
```
app/
  ├── api/            # API 路由和处理函数
  ├── core/           # 核心配置和工具
  ├── crud/           # 数据库 CRUD 操作
  ├── db/             # 数据库相关配置
  ├── models/         # 数据模型定义
  ├── schemas/        # Pydantic 模型
  └── services/       # 业务逻辑服务
```

### 2. 导入规范
- 绝对导入优于相对导入
- 导入顺序：标准库 > 第三方库 > 本地模块
- 避免循环导入
- 在 `__init__.py` 中明确声明可导出的内容

### 3. 异常处理
- 自定义异常类继承自 `HTTPException`
- 所有可预见的异常都要明确处理
- 使用日志记录异常信息
- 返回友好的错误信息给客户端

## API 设计规范

### 1. 接口命名
- 使用 RESTful 风格
- URL 使用小写字母，单词间用短横线连接
- 复数形式表示资源集合
- 版本号放在 URL 中：`/api/v1/`

### 2. 响应格式
```json
{
    "code": 200,
    "message": "success",
    "data": {}
}
```

### 3. 状态码使用
- 200：成功
- 201：创建成功
- 400：客户端错误
- 401：未授权
- 403：禁止访问
- 404：资源不存在
- 500：服务器错误

## 安全规范

### 1. 身份认证
- 使用 JWT 进行身份认证
- Token 过期时间不超过 24 小时
- 敏感操作需要二次验证
- 密码必须加密存储

### 2. 数据安全
- 敏感信息必须加密存储
- API 请求必须使用 HTTPS
- 定期备份数据库
- 记录关键操作日志

## 测试规范

### 1. 单元测试
- 使用 pytest 进行测试
- 测试文件命名：`test_*.py`
- 每个模块的测试覆盖率不低于 80%
- 测试用例必须独立，不能相互依赖

### 2. 集成测试
- 测试完整的业务流程
- 模拟真实的用户场景
- 测试数据库事务
- 测试异步任务

## 部署规范

### 1. 环境配置
- 使用 `.env` 文件管理环境变量
- 区分开发、测试、生产环境
- 生产环境禁用调试模式
- 使用 Docker 容器化部署

### 2. 日志管理
- 使用 logging 模块记录日志
- 按日期和级别分类日志文件
- 记录详细的错误堆栈信息
- 定期清理过期日志

## 文档规范

### 1. 代码注释
- 每个函数都要有文档字符串
- 复杂逻辑必须添加注释说明
- 使用英文编写注释
- 保持注释的及时更新

### 2. API 文档
- 使用 Swagger/OpenAPI 生成文档
- 详细描述请求和响应格式
- 提供示例代码
- 及时更新文档

## 性能优化

### 1. 数据库优化
- 合理使用索引
- 避免 N+1 查询问题
- 大量数据使用异步处理
- 使用缓存减少数据库访问

### 2. 代码优化
- 使用异步处理耗时操作
- 避免循环中的数据库操作
- 合理使用缓存
- 代码性能分析和优化

## 项目管理

### 1. 版本控制
- 使用 Git 进行版本控制
- 遵循 Git Flow 工作流
- 提交信息要清晰明了
- 及时处理代码冲突

### 2. 发布流程
- 自动化构建和部署
- 灰度发布新功能
- 保留回滚机制
- 监控系统状态 